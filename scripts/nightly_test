#!/bin/bash

BREAKOUT_FILE_NAME=~/nightly_test_running

# Don't start the test if it's running already
if [ -f $BREAKOUT_FILE_NAME ]
then
exit
fi

# Create the breakout file
touch $BREAKOUT_FILE_NAME

# We need our git-test
export PATH=$PATH:/usr/local/bin/

# Go into var rethinkdb directory
cd /var/git/rethinkdb/

# Pull latest from master
git pull

# Cloud retester configuration
export USE_CLOUD=true
export EC2_INSTANCE_TYPE=m1.large
export EC2_INSTANCE_COUNT=10

# Generate a temporary VERSION file
VERSION_FILE_INT=$(tempfile -p VERS)
tools/gen-version.sh > "$VERSION_FILE_INT"
export VERSION_FILE="$VERSION_FILE_INT"

# Run the tests
export RETESTER_EMAIL_SENDER=buildbot@rethinkdb.com:allspark
git test -b --revision HEAD --email all@rethinkdb.com --file /var/www/code.rethinkdb.com/htdocs/tests.html test/full_test.py

#TODO: This does not work, as git test -b returns immediately!

# Remove the temporary VERSION file
rm -f "$VERSION_FILE_INT"
unset VERSION_FILE

# Remove the breakout file
rm -f $BREAKOUT_FILE_NAME

