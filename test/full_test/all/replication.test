for (mode, checker) in [
        ("debug", "valgrind"),
        ("release", None)]:
    for protocol in ["text"]:
        for (cores, slices) in [(2, 8)]:
            # Replication
            do_test_fog("integration/serial_mix.py",
                        { "auto"        : True,
                          "mode"        : mode,
                          "no-valgrind" : not checker,
                          "protocol"    : protocol,
                          "cores"       : cores,
                          "slices"      : slices,
                          "duration"    : 340,
                          "failover"    : True},
                        repeat=10, timeout=800)

            # Replication with shorter heartbeat timeout (to provoke disconnects)
            do_test_fog("integration/serial_mix.py",
                        { "auto"        : True,
                          "mode"        : mode,
                          "no-valgrind" : not checker,
                          "protocol"    : protocol,
                          "cores"       : cores,
                          "slices"      : slices,
                          "duration"    : 340,
                          "serve-flags" : "--heartbeat-timeout 10",
                          "failover"    : True},
                        repeat=10, timeout=800)
            do_test_fog("integration/serial_mix.py",
                        { "auto"        : True,
                          "mode"        : mode,
                          "no-valgrind" : not checker,
                          "protocol"    : protocol,
                          "cores"       : cores,
                          "slices"      : slices,
                          "duration"    : 340,
                          "serve-flags" : "--heartbeat-timeout 4",
                          "failover"    : True},
                        repeat=5, timeout=800)

            # ...and one more if we don't use Valgrind (otherwise stuff is too slow for this to work)
            if not checker:
                do_test_fog("integration/serial_mix.py",
                            { "auto"        : True,
                              "mode"        : mode,
                              "no-valgrind" : not checker,
                              "protocol"    : protocol,
                              "cores"       : cores,
                              "slices"      : slices,
                              "duration"    : 340,
                              "serve-flags" : "--heartbeat-timeout 1",
                              "failover"    : True},
                            repeat=5, timeout=800)
            # Replication with large values
            do_test_fog("integration/serial_mix.py",
                          { "auto"        : True,
                            "mode"        : mode,
                            "no-valgrind" : not checker,
                            "protocol"    : protocol,
                            "cores"       : cores,
                            "slices"      : slices,
                            "valuesize"   : 2 * 1024 * 1024,
                            "duration"    : 340,
                            "failover"    : True,
                            "kill-failover-server-prob": 0.1,
                            "resurrect-failover-server-prob": 0.1},
                                  repeat=5, timeout=800)

            # Replication with CAS
            do_test_fog("integration/cas.py",
                        { "auto"        : True,
                          "mode"        : mode,
                          "no-valgrind" : not checker,
                          "protocol"    : protocol,
                          "cores"       : cores,
                          "slices"      : slices,
                          "failover"    : True,
                          "kill-failover-server-prob": 0.1,
                          "resurrect-failover-server-prob": 0.1,
                          "timeout"     : 800},
                        repeat=5, timeout=800)

            # Replication with flags
            do_test_fog("integration/flags.py",
                        { "auto"        : True,
                          "mode"        : mode,
                          "no-valgrind" : not checker,
                          "protocol"    : protocol,
                          "cores"       : cores,
                          "slices"      : slices,
                          "failover"    : True,
                          "kill-failover-server-prob": 0.1,
                          "resurrect-failover-server-prob": 0.1,
                          "timeout"     : 240},
                        repeat=5, timeout=800)

            do_test_fog("integration/replication.py",
                        { "auto"        : True,
                          "mode"        : mode,
                          "no-valgrind" : not checker,
                          "protocol"    : protocol,
                          "cores"       : cores,
                          "slices"      : slices,
                          "duration"    : 340 },
                        repeat=5, timeout=460 * ec2)

            do_test_fog("integration/replication_noise.py",
                        { "auto"        : True,
                          "mode"        : mode,
                          "no-valgrind" : not checker,
                          "protocol"    : protocol,
                          "cores"       : cores,
                          "slices"      : slices,
                          "duration"    : 90
                        },
                        repeat=1, timeout=150*ec2)

