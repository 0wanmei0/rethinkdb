#!/bin/bash

BENCH_DIR="$HOME/bench/$(date +%Y-%m-%d-%H:%M)"

# Horrible but working way of finding the argument after --email.
email="$(perl -e 'use List::Util qw(first); my $email_idx = 1 + first { $ARGV[$_] eq "--email" } 0 .. $#ARGV; print $ARGV[$email_idx]' -- "$@")"

cd src

make clean
make -j DEBUG=0 VALGRIND=0

cd ../bench/stress-client

make
scp stress dr-doom:/home/teapot/stress

cd ../dbench

mkdir -p "$BENCH_DIR"

# A regular benchmark is 10^9 operations, but when profiling, it's run 5 times, so we only do 10^8 operations.

function delete_database_files() { # They are large and useless.
    rm -f "$(find "$BENCH_DIR" -name rethinkdb_data)"
}

#./dbench -d "$BENCH_DIR/bench_output/c1"  -H 10.0.0.2 {server}rethinkdb:'-c 1  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files()
#./dbench -d "$BENCH_DIR/bench_output/c2"  -H 10.0.0.2 {server}rethinkdb:'-c 2  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files()
#./dbench -d "$BENCH_DIR/bench_output/c4"  -H 10.0.0.2 {server}rethinkdb:'-c 4  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files()
#./dbench -d "$BENCH_DIR/bench_output/c8"  -H 10.0.0.2 {server}rethinkdb:'-c 8  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files()
./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 12 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
delete_database_files()
#./dbench -d "$BENCH_DIR/bench_output/c32" -H 10.0.0.2 {server}rethinkdb:'-c 32 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files()
./dbench -d "$BENCH_DIR/bench_output/c12" -H 10.0.0.2 {server}rethinkdb:'-c 12 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000 -w 0/0/1/0' iostat:1 vmstat:1 rdbstat:1
delete_database_files()
#./dbench -d  "$BENCH_DIR/prof_output"     -H 10.0.0.2 {server}rethinkdb:'-c 12 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 10000000'             iostat:1 vmstat:1 rdbstat:1 oprofile
#delete_database_files()

cd ../format

# Generate statistics and email.
./report.py "$BENCH_DIR" "$email"
