#!/bin/bash

BENCH_DIR="$HOME/bench/$(date +%Y-%m-%d-%H:%M)"

mkdir -p "$BENCH_DIR"

# Generate "latest" symlink
rm -f $HOME/bench/latest
ln -s $BENCH_DIR $HOME/bench/latest

exec > "$BENCH_DIR/full_bench.log" 2>&1


# Horrible but working way of finding the argument after --email.
email="$(perl -e 'use List::Util qw(first); my $email_idx = 1 + first { $ARGV[$_] eq "--email" } 0 .. $#ARGV; print $ARGV[$email_idx]' -- "$@")"

cd src

make clean
make -j DEBUG=0 VALGRIND=0

cd ../bench/stress-client

make
scp stress dr-doom:/home/teapot/stress

cd ../dbench

# A regular benchmark is 10^9 operations, but when profiling, it's run 5 times, so we only do 10^8 operations.

function delete_database_files() { # They are large and useless.
    rm -f "$(find "$BENCH_DIR" -name rethinkdb_data)"
}

duration=10000000

#Core scalability
#./dbench -d "$BENCH_DIR/bench_output/c1"  -H 10.0.0.2 {server}rethinkdb:'-c 1  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 600s'            iostat:1 vmstat:1 rdbstat:1
delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c2"  -H 10.0.0.2 {server}rethinkdb:'-c 2  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c4"  -H 10.0.0.2 {server}rethinkdb:'-c 4  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c8"  -H 10.0.0.2 {server}rethinkdb:'-c 8  -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 600s'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c32" -H 10.0.0.2 {server}rethinkdb:'-c 32 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files

#Concurrent clients
#./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 1024 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 2048 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 4096 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 8192 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files
#./dbench -d "$BENCH_DIR/bench_output/c16" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 16384 -d 100000000'            iostat:1 vmstat:1 rdbstat:1
#delete_database_files

#Multiple drives
# XXX: When do we specify the number of slices, etc.?
#../../build/release/rethinkdb --create -f /dev/sdb
#./dbench -d "$BENCH_DIR/bench_output/c16-1d" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128 -m 512 -f /dev/sdb' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 600s'            iostat:1 vmstat:1 rdbstat:1
#../../build/release/rethinkdb --create -f /dev/sdb -f /dev/sdc
#./dbench -d "$BENCH_DIR/bench_output/c16-2d" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128 -m 512 -f /dev/sdb -f /dev/sdc' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 600s'            iostat:1 vmstat:1 rdbstat:1
#../../build/release/rethinkdb --create -f /dev/sdb -f /dev/sdc -f /dev/sdd
#./dbench -d "$BENCH_DIR/bench_output/c16-3d" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128 -m 512 -f /dev/sdb -f /dev/sdc -f /dev/sdd' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 600s'            iostat:1 vmstat:1 rdbstat:1
#../../build/release/rethinkdb --create -f /dev/sdb -f /dev/sdc -f /dev/sdd -f /dev/sde
#./dbench -d "$BENCH_DIR/bench_output/c16-4d" -H 10.0.0.2 {server}rethinkdb:'-c 16 -s 128 -m 512 -f /dev/sdb -f /dev/sdc -f /dev/sdd -f /dev/sde' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 600s'            iostat:1 vmstat:1 rdbstat:1

#OProfile
#./dbench -d  "$BENCH_DIR/prof_output"     -H 10.0.0.2 {server}rethinkdb:'-c 12 -s 128' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 10000000'             iostat:1 vmstat:1 rdbstat:1 oprofile
#delete_database_files

# test COW in the buffer cache
delete_database_files
./dbench -d "$BENCH_DIR/bench_output/canonical" -H 10.0.0.2 {server}rethinkdb:'-c 12 -m 4096 --active-data-extents 1' {client}stressfree[dr-doom:/home/teapot/stress]:'-c 512 -d 60s'            iostat:1 vmstat:1 rdbstat:1
delete_database_files


cd ../format

# Generate statistics and email.
./report.py "$BENCH_DIR" "$email" > "$BENCH_DIR/report.log" 2>&1

