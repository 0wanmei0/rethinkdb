#!/bin/bash
. `cd -P -- "$(dirname $0)" && pwd -P`/init.sh

hosts=$1
num_instances=$2
rdb_dir=$3
staging=$4
server_opts=$5
servers="::: $hosts ::: `seq $num_instances`"

staging_dirs=`seq -f "$staging%g " $num_instances | tr "\n" " "`

parallel -uj0 "echo Prepping {}...; ssh_to {} <<\"EOF\"
sudo service distcc-chroot stop >/dev/null 2>/dev/null
sudo swapoff -a
sudo killall -q rethinkdb
for d in $staging_dirs; do
    [[ -e \$d ]] || { echo \"ERROR no directory \$d on {}\"; exit 1; }
    sudo chown ubuntu:ubuntu \$d
    rm -rf \$d/*
    mkdir -p \$d/.persist
done
EOF" ::: $hosts >&2

parallel -uj0 echo "Distributing $rdb_dir to {1}{2}...;" \
    "rsync_to '$rdb_dir/*' {1} $staging{2}/.persist" $servers >&2

jline=`parallel 'printf -- " -j {1}:$(({2}+$CLUSTER_PORT))"' $servers`
parallel -uj0 "ssh_to {1} <<EOF
cd $staging{2}
set -m
</dev/null nohup .persist/rethinkdb $server_opts \
  $jline -o {2} -n {1}{2} --bind all >1.log 2>2.log &
EOF" $servers >&2
